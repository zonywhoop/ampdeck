<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Ampdeck Settings</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 12px;
            color: #9B9B9B;
            background: #2D2D2D;
            margin: 0;
            padding: 12px;
        }
        .sdpi-heading {
            color: #969696;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 12px 0 8px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid #3a3a3a;
        }
        .sdpi-item {
            margin-bottom: 10px;
        }
        .sdpi-item label {
            display: block;
            margin-bottom: 4px;
            color: #ccc;
        }
        .sdpi-item input, .sdpi-item select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            background: #1a1a1a;
            color: #ccc;
            font-size: 12px;
            box-sizing: border-box;
        }
        .sdpi-item input:focus, .sdpi-item select:focus {
            outline: none;
            border-color: #0078d7;
        }
        .sdpi-item-checkbox {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sdpi-item-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        .sdpi-item-checkbox label {
            display: inline;
            margin: 0;
            color: #ccc;
        }
        .help-text {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }
        button {
            padding: 8px 16px;
            background: #0078d7;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
        }
        button:hover {
            background: #1084e0;
        }
        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .btn-row button {
            flex: 1;
            margin-top: 0;
        }
        #status {
            padding: 10px;
            background: #1a1a1a;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 11px;
            display: none;
            line-height: 1.5;
        }
        #status.show { display: block; }
        #status.success { border-left: 3px solid #4CAF50; }
        #status.error { border-left: 3px solid #f44336; }
        #status.warning { border-left: 3px solid #ff9800; }
        #status.info { border-left: 3px solid #2196F3; }
    </style>
</head>
<body>
    <div class="sdpi-heading">Appearance</div>

    <div class="sdpi-item">
        <label>Text Color</label>
        <select id="textColor">
            <option value="#FFFFFF">White</option>
            <option value="#BBBBBB">Light Gray</option>
            <option value="#E5A00D">Orange</option>
            <option value="#FFBF00">Amber</option>
            <option value="#000000">Black</option>
        </select>
        <div class="help-text">Primary text color on buttons</div>
    </div>

    <div class="sdpi-item-checkbox">
        <input type="checkbox" id="dynamicColors" checked>
        <label for="dynamicColors">Dynamic accent colors from album art</label>
    </div>
    <div class="help-text" style="margin-top: -6px; margin-bottom: 10px;">When off, accent colors stay orange</div>

    <div class="sdpi-heading">Plexamp Player</div>

    <div class="sdpi-item">
        <label>Player URL</label>
        <input type="text" id="playerUrl" placeholder="http://localhost:32500">
        <div class="help-text">Local Plexamp address. Default: http://localhost:32500 (headless). Desktop users may need a different port.</div>
    </div>

    <div class="sdpi-heading">Plex Server</div>
    
    <div class="sdpi-item">
        <label>Server URL</label>
        <input type="text" id="plexServerUrl" placeholder="http://your-server-ip:32400">
        <div class="help-text">Your Plex server address with port (used for metadata and album art)</div>
    </div>
    
    <div class="sdpi-item">
        <label>Plex Token</label>
        <input type="password" id="plexToken" placeholder="Your Plex token">
        <div class="help-text">Find in Plex settings or browser network tab</div>
    </div>
    
    <div class="sdpi-item">
        <label>Client Name</label>
        <input type="text" id="clientName" placeholder="e.g. My PC">
        <div class="help-text">Your PC name as shown in Plex dashboard (used for server fallback)</div>
    </div>

    <div class="sdpi-heading">Advanced</div>

    <div class="sdpi-item">
        <label>Time Offset (ms)</label>
        <input type="number" id="syncOffset" placeholder="0" step="100" min="-5000" max="10000">
        <div class="help-text">Only needed if using server fallback mode. Default: 0</div>
    </div>

    <div class="sdpi-item-checkbox">
        <input type="checkbox" id="debugMode">
        <label for="debugMode">Enable debug logging</label>
    </div>
    <div class="help-text" style="margin-top: -6px; margin-bottom: 10px;">Logs detailed API requests and responses to the browser console</div>

    <div class="btn-row">
        <button id="testPlayerBtn">Test Player</button>
        <button id="testServerBtn">Test Server</button>
    </div>
    <div id="status"></div>

    <script>
        let websocket = null;
        let uuid = null;
        let actionInfo = null;

        function connectElgatoStreamDeckSocket(inPort, inPropertyInspectorUUID, inRegisterEvent, inInfo, inActionInfo) {
            uuid = inPropertyInspectorUUID;
            actionInfo = JSON.parse(inActionInfo);
            
            const settings = actionInfo.payload.settings || {};
            
            document.getElementById('textColor').value = settings.textColor || '#FFFFFF';
            document.getElementById('dynamicColors').checked = settings.dynamicColors !== false;
            document.getElementById('playerUrl').value = settings.playerUrl || '';
            document.getElementById('plexServerUrl').value = settings.plexServerUrl || '';
            document.getElementById('plexToken').value = settings.plexToken || '';
            document.getElementById('clientName').value = settings.clientName || '';
            document.getElementById('syncOffset').value = settings.syncOffset !== undefined ? settings.syncOffset : 0;
            document.getElementById('debugMode').checked = settings.debugMode === true;

            websocket = new WebSocket('ws://127.0.0.1:' + inPort);
            
            websocket.onopen = function() {
                websocket.send(JSON.stringify({
                    event: inRegisterEvent,
                    uuid: inPropertyInspectorUUID
                }));
                
                websocket.send(JSON.stringify({
                    event: "getGlobalSettings",
                    context: inPropertyInspectorUUID
                }));
            };

            websocket.onmessage = function(evt) {
                const msg = JSON.parse(evt.data);
                if (msg.event === 'didReceiveGlobalSettings') {
                    const s = msg.payload.settings || {};
                    if (s.playerUrl) document.getElementById('playerUrl').value = s.playerUrl;
                    if (s.plexServerUrl) document.getElementById('plexServerUrl').value = s.plexServerUrl;
                    if (s.plexToken) document.getElementById('plexToken').value = s.plexToken;
                    if (s.clientName) document.getElementById('clientName').value = s.clientName;
                    if (s.syncOffset !== undefined) document.getElementById('syncOffset').value = s.syncOffset;
                    if (s.textColor) document.getElementById('textColor').value = s.textColor;
                    if (s.dynamicColors !== undefined) document.getElementById('dynamicColors').checked = s.dynamicColors;
                    if (s.debugMode !== undefined) document.getElementById('debugMode').checked = s.debugMode;
                }
            };
        }

        function saveSettings() {
            const settings = {
                textColor: document.getElementById('textColor').value,
                dynamicColors: document.getElementById('dynamicColors').checked,
                playerUrl: document.getElementById('playerUrl').value.trim(),
                plexServerUrl: document.getElementById('plexServerUrl').value.trim(),
                plexToken: document.getElementById('plexToken').value.trim(),
                clientName: document.getElementById('clientName').value.trim(),
                syncOffset: parseInt(document.getElementById('syncOffset').value) || 0,
                debugMode: document.getElementById('debugMode').checked
            };

            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    event: 'setSettings',
                    context: uuid,
                    payload: settings
                }));
                
                websocket.send(JSON.stringify({
                    event: 'setGlobalSettings',
                    context: uuid,
                    payload: settings
                }));
            }
        }

        document.getElementById('textColor').addEventListener('change', saveSettings);
        document.getElementById('dynamicColors').addEventListener('change', saveSettings);
        document.getElementById('playerUrl').addEventListener('change', saveSettings);
        document.getElementById('plexServerUrl').addEventListener('change', saveSettings);
        document.getElementById('plexToken').addEventListener('change', saveSettings);
        document.getElementById('clientName').addEventListener('change', saveSettings);
        document.getElementById('syncOffset').addEventListener('change', saveSettings);
        document.getElementById('debugMode').addEventListener('change', saveSettings);

        // Test Player Connection (local Plexamp API)
        document.getElementById('testPlayerBtn').addEventListener('click', async function() {
            const statusEl = document.getElementById('status');
            const playerUrl = document.getElementById('playerUrl').value.trim() || 'http://localhost:32500';

            statusEl.className = 'show info';
            statusEl.textContent = 'Testing player connection...';

            try {
                const response = await fetch(playerUrl + '/player/timeline/poll?wait=0&commandID=1', {
                    headers: { 'X-Plex-Client-Identifier': 'com.rackemrack.ampdeck' }
                });

                if (!response.ok) throw new Error('HTTP ' + response.status);

                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/xml');
                const musicTl = Array.from(doc.querySelectorAll('Timeline')).find(t => t.getAttribute('type') === 'music');
                
                if (musicTl) {
                    const state = musicTl.getAttribute('state') || 'stopped';
                    if (state !== 'stopped') {
                        statusEl.className = 'show success';
                        statusEl.textContent = '✓ Player connected! State: ' + state;
                    } else {
                        statusEl.className = 'show warning';
                        statusEl.textContent = '⚠ Player connected, but nothing is playing. Start playback in Plexamp to test fully.';
                    }
                } else {
                    statusEl.className = 'show warning';
                    statusEl.textContent = '⚠ Player responded, but no music timeline found.';
                }

                saveSettings();
            } catch (e) {
                statusEl.className = 'show error';
                statusEl.textContent = '✗ Player connection failed: ' + e.message + '\nMake sure Plexamp is running and the URL/port is correct.';
            }
        });

        // Test Server Connection (Plex server for metadata)
        document.getElementById('testServerBtn').addEventListener('click', async function() {
            const statusEl = document.getElementById('status');
            const serverUrl = document.getElementById('plexServerUrl').value.trim();
            const token = document.getElementById('plexToken').value.trim();
            const clientName = document.getElementById('clientName').value.trim();

            if (!serverUrl || !token) {
                statusEl.className = 'show error';
                statusEl.textContent = 'Please enter server URL and token';
                return;
            }

            statusEl.className = 'show info';
            statusEl.textContent = 'Testing server connection...';

            try {
                const response = await fetch(serverUrl + '/status/sessions?X-Plex-Token=' + token, {
                    headers: { 'Accept': 'application/json' }
                });

                if (!response.ok) throw new Error('HTTP ' + response.status);

                const data = await response.json();
                const sessions = data.MediaContainer?.Metadata || [];
                
                let found = false;
                let foundClient = null;
                for (const session of sessions) {
                    if (session.Player?.product === 'Plexamp' || session.Player?.title === clientName) {
                        found = true;
                        foundClient = session.Player?.title;
                        break;
                    }
                }

                if (found) {
                    statusEl.className = 'show success';
                    statusEl.textContent = '✓ Server connected! Found Plexamp on "' + (foundClient || clientName) + '"';
                } else if (sessions.length > 0) {
                    statusEl.className = 'show warning';
                    const clients = sessions.map(s => s.Player?.title).filter(Boolean).join(', ');
                    statusEl.textContent = '⚠ Server connected, but no Plexamp session found. Active: ' + (clients || 'Unknown');
                } else {
                    statusEl.className = 'show warning';
                    statusEl.textContent = '⚠ Server connected! No active sessions. Start playing something in Plexamp.';
                }
                
                saveSettings();
            } catch (e) {
                statusEl.className = 'show error';
                statusEl.textContent = '✗ Server connection failed: ' + e.message;
            }
        });
    </script>
</body>
</html>
